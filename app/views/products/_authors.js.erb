<script>

var ready = function(){
	var urls_from_html = $('#author_urls').text().split(' ');
	var ids_from_html = $('#review_ids').text().split(' ');
	urls_from_html.pop();
	ids_from_html.pop();


	$('#user-data-button').click(function(){
		$('#user-data-panel').html('<%= image_tag "ajax-loader.gif" %>');
		$.ajax({
			'url': '/author-data',
			'type':	'POST',
			'data': {
			    	'urls' : urls_from_html,
				'ids' : ids_from_html
			    }
			 
			}).done(function(map_data) {
			if (map_data.status == 500) {
			   $('#user-data-panel').html("There was an error loading user data.");
			}
			else {
			   $('#user-data-panel').html(map_data.length.toString() + " users were loaded.");
			   
			   var rating_hash = {};
			   var count_hash = {};

			   map_data.forEach(function(obj) {
			   	var state_abbr = obj.state_abbr;
				var rating = obj.rating;

			   	if (rating_hash[obj.state_abbr] == null) {
			   	   rating_hash[state_abbr] = rating;
			   	   count_hash[state_abbr] = 1;
			   	   }
			   	else {
			   	   rating_hash[state_abbr] += rating;
			   	   count_hash[state_abbr] += 1;
			   	   }
			   	})

			   for (state_abbr in rating_hash) {
			       if (rating_hash.hasOwnProperty(state_abbr)) {
			       	  rating_hash[state_abbr] = (rating_hash[state_abbr] / count_hash[state_abbr]) / 5;  	  
			       }
			   }

			   buildMap(rating_hash);
			   $('#graph1').show();
			   }			   
			});				
	});


}

$(document).ready(ready);
$(document).on('page:load', ready);

</script>